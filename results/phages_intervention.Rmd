---
title: "Data analysis: Intervention Phages"
output: html_notebook
---

## Experiment by ENVIRE partner: Poland

2 week-old chickens were purchased from farm with high resistance levels. Chickens were monitored 5 times: 
day 0 and weekly for 4 weeks. That day chickens were 42 days old. Starting from day 0, each 7-day litter 
was treated with sprayed phages at titer 10^10 pfu/ml. After chicken removal litter was pulled outside and 
is being stored.


```{r setup, include=FALSE}
source(here::here("visualization.R"))
source(here::here("run_farm_module_parallel.R"))

inputs <- load_inputs()
n_sim  <- inputs$n_sim
input_manual <- list(farm_size = 7.7)

parallel_output <-
  batch_simulator_parallel(farm_module = new.farm_module(input_list = load_inputs(input_manual)),
                           n_sim = n_sim)
output_avg      <- apply(parallel_output, c(1, 2), mean)

## Data from partners
C_esbl_feces <- c(4.11e6, 3.07e5, 5.51e6, 3.83e6, 1.39e6)
C_esbl_feces_phages <- c(5.37e5, 1.47e5, 1.67e6, 6.47e5, 5.64e4)

day_idx <- c(1, 7, 14, 21, 27)

## Plot for average (over broilers + iterations) excreted bacteria 

qoi1 <- log10(output_avg[, 3])[day_idx]
gg <- ggplot(data = data.frame(
  days = day_idx,  
  qoi1 = qoi1,  
  qoi2 = log10(C_esbl_feces),
  qoi3 = log10(C_esbl_feces_phages)
)) +
  geom_point(aes(x = days, y = qoi1, color = "Simulated"), size = 3) +  
  geom_line(aes(x = days, y = qoi1, color = "Simulated")) +   
  geom_point(aes(x = days, y = qoi2, color = "Treated"), size = 3) + 
  geom_line(aes(x = days, y = qoi2, color = "Treated")) + 
  geom_point(aes(x = days, y = qoi3, color = "Untreated"), size = 3) + 
  geom_line(aes(x = days, y = qoi3, color = "Untreated")) + 
  labs(
    title = "Average Bacterial concentration in excreted feces",
    subtitle = paste(dim(parallel_output)[3], "simulations"),
    x = "Days",
    y = "ESBL E. coli (log10 CFU/g)"
  ) +
  scale_color_manual(values = c("Simulated" = "red", "Treated" = "blue", "Untreated" = "black"),
                     labels = c("Simulated", "Treated", "Untreated"))

gg
```
